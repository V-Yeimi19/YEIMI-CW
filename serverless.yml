service: cw-infra-shared

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: dev
  environment:
    CONNECTIONS_TABLE: !Ref ConnectionsTable
    EVENT_BUS_NAME: !Ref CentralEventBus
    # Configuración para Powertools y Node
    POWERTOOLS_SERVICE_NAME: WebSocketService
    NODE_OPTIONS: --enable-source-maps
  
  iam: 
    role: arn:aws:iam::${aws:accountId}:role/LabRole

plugins:
  - serverless-esbuild
  - serverless-dotenv-plugin # Por si acaso

custom:
  dotenv:
    path: ./.env
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    target: 'node18'
    exclude: ['aws-sdk']
    platform: 'node'
    concurrency: 10

functions:
  # LA LAMBDA RELAY
  UniversalRelay:
    handler: shared/src/lambdas/UniversalRelay.handler
    description: "Lambda comodín para re-ingestar eventos transformados al Bus"

  # RUTAS WEBSOCKET
  wsConnect:
    handler: shared/src/lambdas/Connect.handler
    events:
      - websocket:
          route: $connect

  wsDisconnect:
    handler: shared/src/lambdas/Disconnect.handler
    events:
      - websocket:
          route: $disconnect

  wsDefault:
    handler: shared/src/lambdas/Default.handler
    events:
      - websocket:
          route: $default
  
  wsInboundHandler:
    handler: shared/src/lambdas/RoleAuth.handler
    events:
      # Definimos Eventos de Negocio, no "rutas"
      - websocket:
          route: Productos.Listar
      - websocket:
          route: System.Ping
      - websocket:
          route: Auth.LoginCliente
      - websocket:
          route: Auth.LoginManager
      - websocket:
          route: Auth.RegisterCliente
      - websocket:
          route: Auth.RegisterManager

resources:
  Resources:
    # ---------------------------------------------------
    # BUS DE EVENTOS
    # ---------------------------------------------------
    CentralEventBus:
      Type: AWS::Events::EventBus
      Properties:
        Name: cw-event-bus
  
    # ---------------------------------------------------
    # PERMISOS DE LA LAMBDA RELAY
    # ---------------------------------------------------
    UniversalRelayPermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !GetAtt UniversalRelayLambdaFunction.Arn
        Action: lambda:InvokeFunction
        Principal: events.amazonaws.com
        # Opcional pero recomendado: Restringir a tu Bus específico
        SourceArn: !GetAtt CentralEventBus.Arn

    # ---------------------------------------------------
    # TABLA DE PEDIDOS
    # ---------------------------------------------------
    PedidosTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: cw-pedidos-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: pedido_id
            AttributeType: S
          - AttributeName: entity
            AttributeType: S
          - AttributeName: sucursal
            AttributeType: S
          - AttributeName: estadoFecha
            AttributeType: S
        KeySchema:
          - AttributeName: pedido_id
            KeyType: HASH
          - AttributeName: entity
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: SucursalIndex
            KeySchema:
              - AttributeName: sucursal
                KeyType: HASH
              - AttributeName: estadoFecha
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    # ---------------------------------------------------
    # TABLA DE CONEXIONES WEBSOCKET
    # ---------------------------------------------------
    ConnectionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: cw-connections-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        
        # Definimos SOLO los atributos que son Keys o Índices
        AttributeDefinitions:
          - AttributeName: connection_id
            AttributeType: S
          - AttributeName: user_id
            AttributeType: S
          - AttributeName: tenant_id
            AttributeType: S
        
        # Primary Key (PK)
        KeySchema:
          - AttributeName: connection_id
            KeyType: HASH

        # Configuración de TTL (Limpieza automática)
        # Sigue la columna 'ttl' de tu imagen
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true

        # Índices Secundarios Globales (GSI)
        GlobalSecondaryIndexes:
          # GSI 1: Para buscar por Usuario (Caso 2 y 3)
          - IndexName: user_id-index
            KeySchema:
              - AttributeName: user_id
                KeyType: HASH
            # Proyectamos todo por si luego quieres filtrar por 'Role'
            Projection:
              ProjectionType: ALL

          # GSI 2: Para buscar por Tenant/Sucursal (Caso 4)
          - IndexName: tenant_id-index
            KeySchema:
              - AttributeName: tenant_id
                KeyType: HASH
            Projection:
              ProjectionType: ALL
    
    # ---------------------------------------------------
    # TABLA DE USUARIOS
    # ---------------------------------------------------
    UsuariosTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: cw-usuarios-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: user_id
            AttributeType: S
          - AttributeName: entity
            AttributeType: S
          - AttributeName: tenant_context
            AttributeType: S
          - AttributeName: Role
            AttributeType: S
        KeySchema:
          - AttributeName: user_id
            KeyType: HASH
          - AttributeName: entity
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: TenantRoleIndex
            KeySchema:
              - AttributeName: tenant_context
                KeyType: HASH
              - AttributeName: Role
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    # ---------------------------------------------------
    # TABLA DE INVENTARIO
    # ---------------------------------------------------
    InventoryTable:
      Type: AWS::DynamoDB::Table
      Properties:
        # Nombre físico: t_inventario_dev, t_inventario_prod
        TableName: cw-inventario-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        
        # Definimos los atributos que usaremos como Llaves o Índices
        AttributeDefinitions:
          - AttributeName: producto_id
            AttributeType: S
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: tipo_id
            AttributeType: S
        
        # Primary Key (PK) Principal
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH 
          - AttributeName: producto_id
            KeyType: RANGE

        # Índices Secundarios Globales (GSI)
        GlobalSecondaryIndexes:
          
          # GSI 1: Para buscar productos por SUCURSAL (tenant_id)
          # Query: Dame todo el inventario de "SURCO_1"
          - IndexName: producto_id-index
            KeySchema:
              - AttributeName: producto_id
                KeyType: HASH
              - AttributeName: tenant_id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL # Traemos stock, precio, etc.

          # GSI 2: Para buscar productos por TIPO (tipo_id)
          # Query: Dame todos los "Mostrazo_Chinawok" (de todas las tiendas)
          # Útil para reportes globales o catálogo general
          - IndexName: tipo_id-index
            KeySchema:
              - AttributeName: producto_id
                KeyType: HASH
              - AttributeName: tipo_id
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    # ---------------------------------------------------
    # COGNITO USER POOL
    # ---------------------------------------------------
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: cw-user-pool-${self:provider.stage}
        # Configuración para loguearse con Email en lugar de Username
        UsernameAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        # Atributos estándar que vas a usar
        Schema:
          - Name: email
            Required: true
            Mutable: true
          - Name: name
            Required: true
            Mutable: true
        # Políticas de contraseña (opcional, ajústalo a tu gusto)
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
            RequireUppercase: true

    # ---------------------------------------------------
    # 2. APP CLIENT (La "Llave" para tu Backend)
    # ---------------------------------------------------
    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: cw-app-client-${self:provider.stage}
        UserPoolId: !Ref CognitoUserPool
        GenerateSecret: false # False para apps web/mobile/lambda directas
        
        # FLUJOS DE AUTENTICACIÓN (Vital para tu Step Function)
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH        # Para login directo (user/pass)
          - ALLOW_REFRESH_TOKEN_AUTH        # Para renovar tokens
          - ALLOW_ADMIN_USER_PASSWORD_AUTH  # Para login administrativo (backend)
          - ALLOW_USER_SRP_AUTH             # Protocolo seguro estándar

    # ---------------------------------------------------
    # 3. GRUPOS DE SEGURIDAD (RBAC)
    # ---------------------------------------------------
    
    # Grupo: ADMIN
    GroupAdmin:
      Type: AWS::Cognito::UserPoolGroup
      Properties:
        GroupName: Admin
        UserPoolId: !Ref CognitoUserPool
        Description: "Super usuarios del sistema"
        Precedence: 0 # Mayor prioridad

    # Grupo: MANAGERS
    GroupManagers:
      Type: AWS::Cognito::UserPoolGroup
      Properties:
        GroupName: Managers
        UserPoolId: !Ref CognitoUserPool
        Description: "Administradores de sucursal/tenant"
        Precedence: 5

    # Grupo: CLIENTES
    GroupClientes:
      Type: AWS::Cognito::UserPoolGroup
      Properties:
        GroupName: Clientes
        UserPoolId: !Ref CognitoUserPool
        Description: "Usuarios finales de la app"
        Precedence: 10

  # 2. Exportamos los valores para que los microservicios los lean
  Outputs:
    # URL base del WebSocket
    # NOTA: Al agregar la sección 'functions' con eventos websocket, 
    # Serverless crea automágicamente el recurso lógico 'WebsocketsApi'.
    # Por eso este Output ahora funcionará correctamente.
    WebSocketEndpointUrl:
      Description: "URL del WebSocket API para enviar respuestas (PostToConnection)"
      # Construimos la URL: https://{API_ID}.execute-api.{REGION}.amazonaws.com/{STAGE}
      Value:
        Fn::Join:
          - ""
          - - "https://"
            - Ref: WebsocketsApi  # Referencia automática al API creado por Serverless
            - ".execute-api."
            - Ref: "AWS::Region"
            - ".amazonaws.com/"
            - ${self:provider.stage}
      Export:
        Name: cw-websocket-endpoint-${self:provider.stage}
    
    # NOMBRE de la Bus de Eventos
    BusNameExport:
      Value: !Ref CentralEventBus
      Export:
        Name: cw-event-bus-name-${self:provider.stage}

    # ARN de la Bus de Eventos
    BusArnExport:
      Value: !GetAtt CentralEventBus.Arn
      Export:
        Name: cw-event-bus-arn-${self:provider.stage}

    # NOMBRE de la tabla
    PedidosTableName:
      Description: "Nombre de la tabla de pedidos"
      Value: !Ref PedidosTable
      Export:
        Name: cw-pedidos-table-name-${self:provider.stage}

    # ARN de la tabla
    PedidosTableArn:
      Description: "ARN de la tabla de pedidos"
      Value: !GetAtt PedidosTable.Arn
      Export:
        Name: cw-pedidos-table-arn-${self:provider.stage}
    
    # NOMBRE de la tabla
    ConnectionsTableName:
      Description: "Nombre de la tabla de conexiones"
      Value: !Ref ConnectionsTable
      Export:
        Name: cw-connections-table-name-${self:provider.stage}

    # ARN de la tabla
    ConnectionsTableArn:
      Description: "ARN de la tabla de conexiones"
      Value: !GetAtt ConnectionsTable.Arn
      Export:
        Name: cw-connections-table-arn-${self:provider.stage}
    
    # NOMBRE de la tabla
    UsersTableName:
        Value: !Ref UsuariosTable
        Export:
          Name: cw-users-table-name-${self:provider.stage}
    
    # ARN de la tabla
    UsersTableArn:
        Value: !GetAtt UsuariosTable.Arn
        Export:
          Name: cw-users-table-arn-${self:provider.stage}

    # NOMBRE de la tabla de inventario
    InventoryTableName:
      Description: "Nombre de la tabla de inventario"
      Value: !Ref InventoryTable
      Export:
        Name: cw-inventory-table-name-${self:provider.stage}

    # ARN de la tabla de inventario
    InventoryTableArn:
      Description: "ARN de la tabla de inventario"
      Value: !GetAtt InventoryTable.Arn
      Export:
        Name: cw-inventory-table-arn-${self:provider.stage}

    # ---------------------------------------------------
    # OUTPUTS (Para exportar al Session Manager MS)
    # ---------------------------------------------------
    
    # ID del User Pool
    UserPoolId:
      Value: !Ref CognitoUserPool
      Export:
        Name: cw-auth-user-pool-id-${self:provider.stage}

    # ID del Cliente (App Client ID)
    UserPoolClientId:
      Value: !Ref CognitoUserPoolClient
      Export:
        Name: cw-auth-client-id-${self:provider.stage}

    # ARN del User Pool (A veces útil para permisos IAM)
    UserPoolArn:
      Value: !GetAtt CognitoUserPool.Arn
      Export:
        Name: cw-auth-user-pool-arn-${self:provider.stage}

    # ARN de la Lambda Universal Relay
    UniversalRelayArn:
      Description: "ARN de la Lambda Universal Relay"
      Value: !GetAtt UniversalRelayLambdaFunction.Arn
      Export:
        Name: cw-universal-relay-arn-${self:provider.stage}
