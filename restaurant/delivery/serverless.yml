service: delivery-ms 

# CRÍTICO: dotenv-plugin DEBE ir PRIMERO
plugins:
  - serverless-dotenv-plugin
  - serverless-esbuild

  
custom:
  common: ${file(../../shared/common.yml)}

  # CRÍTICO: dotenv DEBE estar configurado ANTES de usarse
  dotenv:
    path: ../../.env
    logging: true
    required:
      env:
        - SENDGRID_API_KEY

  esbuild: ${self:custom.common.custom.esbuild}

provider:
  name: ${self:custom.common.provider.name}
  runtime: ${self:custom.common.provider.runtime}
  region: ${self:custom.common.provider.region}
  stage: ${self:custom.common.provider.stage}
  memorySize: ${self:custom.common.provider.memorySize}
  timeout: ${self:custom.common.provider.timeout}

  # Heredar la configuración de IAM (NO 'role' directamente)
  iam: ${self:custom.common.provider.iam}

  environment:
    EVENT_BUS_NAME: ${self:custom.common.provider.environment.EVENT_BUS_NAME}
    SENDGRID_API_KEY: ${.env:SENDGRID_API_KEY}
    FROM_EMAIL: ${.env:FROM_EMAIL, 'notificaciones@chinawok.com'}

functions:
  sendEmail:
    handler: src/sendEmail.handler
    description: Envía emails usando SendGrid API
    environment:
      SENDGRID_API_KEY: ${.env:SENDGRID_API_KEY}
      FROM_EMAIL: ${.env:FROM_EMAIL, 'notificaciones@chinawok.com'}

resources:
  Resources:
    DeliveryStateMachine:
      Type: AWS::StepFunctions::StateMachine
      Properties:
        StateMachineName: DeliveryStateMachine-${self:provider.stage}
        # Usar Fn::Sub para obtener el AccountId dinámicamente
        RoleArn: !Sub 'arn:aws:iam::${AWS::AccountId}:role/LabRole'
        DefinitionString:
          Fn::Sub:
            - ${FileContent}
            - FileContent: ${file(./delivery.asl.json)}
              UsuariosTable: ${cf:cw-infra-shared-dev.UsuariosTableName}
              PedidosTable: ${cf:cw-infra-shared-dev.PedidosTableName}
              EventBusName: ${self:custom.common.provider.environment.EVENT_BUS_NAME}
              SendEmailLambdaArn:
                Fn::GetAtt:
                  - SendEmailLambdaFunction
                  - Arn


    PagoConfirmadoRule:
      Type: AWS::Events::Rule
      Properties:
        EventBusName: ${self:custom.common.provider.environment.EVENT_BUS_NAME}
        EventPattern:
          source:
            - payment.service
          detail-type:
            - PagoConfirmado
        State: ENABLED
        Targets:
          - Arn: !GetAtt DeliveryStateMachine.Arn
            RoleArn: !Sub 'arn:aws:iam::${AWS::AccountId}:role/LabRole'
            Id: DeliveryStateMachineTarget

    ComidaPreparadaRule:
      Type: AWS::Events::Rule
      Properties:
        EventBusName: ${self:custom.common.provider.environment.EVENT_BUS_NAME}
        EventPattern:
          source:
            - kitchen.service
          detail-type:
            - ComidaPreparada
        State: ENABLED
        Targets:
          - Arn: !GetAtt DeliveryStateMachine.Arn
            RoleArn: !Sub 'arn:aws:iam::${AWS::AccountId}:role/LabRole'
            Id: DeliveryStateMachineTarget

    DespachadoRule:
      Type: AWS::Events::Rule
      Properties:
        EventBusName: ${self:custom.common.provider.environment.EVENT_BUS_NAME}
        EventPattern:
          source:
            - packing.service
          detail-type:
            - Despachado
        State: ENABLED
        Targets:
          - Arn: !GetAtt DeliveryStateMachine.Arn
            RoleArn: !Sub 'arn:aws:iam::${AWS::AccountId}:role/LabRole'
            Id: DeliveryStateMachineTarget

    EntregadoRule:
      Type: AWS::Events::Rule
      Properties:
        EventBusName: ${self:custom.common.provider.environment.EVENT_BUS_NAME}
        EventPattern:
          source:
            - driver.service
          detail-type:
            - Entregado
        State: ENABLED
        Targets:
          - Arn: !GetAtt DeliveryStateMachine.Arn
            RoleArn: !Sub 'arn:aws:iam::${AWS::AccountId}:role/LabRole'
            Id: DeliveryStateMachineTarget

  Outputs:
    DeliveryStateMachineArn:
      Value: !GetAtt DeliveryStateMachine.Arn
      Export:
        Name: ${self:service}-${self:provider.stage}-StateMachineArn